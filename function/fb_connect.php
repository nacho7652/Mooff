<?php    require_once('../function/allfunc.php');    require_once( '../php_sdk/facebook.php');    require_once(ABSPATH."function/session.php");  $config = array();  $config['appId'] = 'YOUR_APP_ID';  $config['secret'] = 'YOUR_APP_SECRET';  $config['fileUpload'] = false; // optional  $facebook = new Facebook($config);    $fb_user = $facebook->getUser();    if (!$fb_user) {        $params = array(                    'scope' => "email,user_birthday,user_location,publish_stream,offline_access",                    'redirect_uri' => "http://deenty.com/function/fb_connect.php",                  );                        $loginUrl = $facebook->getLoginUrl($params);        echo("<script> top.location.href='" . $loginUrl . "'</script>");        exit();    } else {      try {        $fbuid = $fb_user;        $fb_user_profile = $facebook->api('/me');        $access_token = $facebook->getAccessToken();        //print_r($fb_user_profile);      } catch (FacebookApiException $e) {        error_log($e);                 $fb_user = null;      }      if( !empty($fbuid) ){        $sql = "SELECT * FROM usuario                 WHERE correo = '{$fb_user_profile['email']}' OR fuid = '{$fb_user_profile['id']}'                 GROUP BY codigo                LIMIT 1";        $query = sqlquery($sql);          $row = mysql_fetch_array( $query, MYSQL_BOTH );                    if(!empty($row['correo'])){          $id = $row["codigo"];          if ( $row["fb_token"] != $access_token ){            //UPDATE token            $dbaccess_token = safeForDB($access_token);            $sql = "UPDATE usuario SET fb_token = $dbaccess_token WHERE codigo = $id LIMIT 1";             $result = sqlquery($sql);          }          if ( $row["fuid"] != $fbuid ){            // UPDATE fbuid            $dbfbuid = safeForDB($fbuid);            $sql = "UPDATE usuario SET fuid = $dbfbuid WHERE codigo = $id LIMIT 1";             $result = sqlquery($sql);          }          echo $user->_checkFBLogin($fbuid, $access_token, true) > 0 ? '' : '';          echo("<script> top.location.href='http://deenty.com';</script>");          exit();                 } else {  // REGISTRAR USUARIO.          $password = md5($fbuid.time());          $randompos = strlen($password)-6;          $password = substr($password, rand(1, $randompos) , 6);          $password = md5($password);                              $cookie = md5($fb_user_profile['name'].$fb_user_profile['email']."deenty");          $randompos = strlen($cookie)-15;          $cookie = substr($cookie, rand(1, $randompos) , 15);          // clave secreta de los nuevos usuarios          $secretKey = md5($password.$fb_user_profile['email']."deenty".$cookie);          $session = session_id();          require_once(ABSPATH."/function/db_controller.php");          $table_name = "usuario";          $fields = array(                "codigo"      => array("int",       array(0,"codigo","","",NULL,"")),                "nombre"      => array("text",      array(2,"nombre","","Nombre *",$fb_user_profile['first_name'],"")),                "apellido"    => array("text",      array(2,"apellido","","Apellido *",$fb_user_profile['last_name'],"")),                "correo"      => array("mail",      array(2,"correo","","E-mail *",$fb_user_profile['email'],"")),                "fuid"        => array("text",      array(0,"fuid","","fuid",$fbuid,"")),                "avatar"      => array("text",      array(0,"avatar","","Imagen","-1","")),                "tel"         => array("text",      array(2,"tel","","Telefono *","","")),                "clave"       => array("text",      array(0,"clave","","ConteseÃ±a",$password,"")),                //"about"       => array("blob",      array(0,"about","","About","","")),                "fecha_ins"   => array("date",      array(0,"fecha_ins","","Fecha","now","","Y-m-d H:i:s")),                "fecha_cad"   => array("date",      array(0,"fecha_ins","","Termino","+1 year","","Y-m-d H:i:s")),                //"cod_grupo"   => array("int",       array(0,"cod_grupo","","","0","")),                //"nivel"       => array("int",       array(0,"nivel","","Nivel","0","")),                "foto"        => array("text",      array(0,"foto","","foto","-1","")),                "rut"         => array("rut",       array(2,"rut","","RUT *","","")),                "cookie"      => array("text",      array(0,"cookie","","cookie",$cookie,"")),                "session"     => array("text",      array(0,"session","","session",$session,"")),                "userkey"     => array("text",      array(0,"userkey","","userkey",$secretKey,"")),                "ip"          => array("text",      array(0,"ip","","ip","","")),                "last_login"  => array("date",      array(0,"last_login","","last_login","now","","Y-m-d H:i:s")),                "fb_token"    => array("text",      array(0,"fb_token","","fb_token",$access_token,""))                );          $test = new DB_Controller($table_name, $fields);          include_once(ABSPATH."/sites/registrarusuario.php");                  }      } else {        // ERROR: FB CONNECTION NULL.      }    }        ?>